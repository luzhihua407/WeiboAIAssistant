import Playwright from '#root/utils/playwright.js';

const initializeBrowser = async (cookies) => {
    let browser = await Playwright.getBrowser();
    if (!browser) {
        browser = await Playwright.launchBrowser();
    }

    const browserContext = await Playwright.getBrowserContext(browser, { storageState: cookies });
    const page = await Playwright.newPage(browserContext);
    const client = await page.context().newCDPSession(page);
    await client.send('Network.enable');
    
    // ÁõëÂê¨ÊâÄÊúâÁΩëÁªú‰∫ã‰ª∂
    client.on('Network.requestWillBeSent', request => {
        const headers = request.request?.headers;
        if (headers && headers['x-requested-with'] === 'XMLHttpRequest') {
            console.log(`\nüöÄ [XHR Request] ${request.request.method} ${request.request.url}`);
        }
    });

    client.on('Network.responseReceived', async response => {
        const request = await client.send('Network.getRequestPostData', { requestId: response.requestId }).catch(() => null);
        const headers = request?.headers;
        if (headers && headers['x-requested-with'] === 'XMLHttpRequest') {
            console.log(`\nüì• [XHR Response] ${response.response.status}`);
        }
    });

    return { browserContext, page,cookies };
};

const closeBrowser = async (browserContext) => {
    try {
        if (browserContext) {
            await browserContext.close(); // ÂÖ≥Èó≠ÊµèËßàÂô®‰∏ä‰∏ãÊñá
        }
    } catch (error) {
        console.error('Error closing browser context:', error);
    }
};
export { initializeBrowser, closeBrowser };